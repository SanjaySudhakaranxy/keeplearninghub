<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Exam - Question Extractor</title>
    <link rel="stylesheet" href="/static/style.css" />
    <style>
      body {
        background: #1a1a1a;
        color: #fff;
      }
      .exam-container {
        max-width: 900px;
        margin: 0 auto;
        padding: 20px;
      }
      .exam-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        background: #2a2a2a;
        padding: 15px;
        border-radius: 8px;
        border: 1px solid #444;
      }
      .progress-bar {
        width: 100%;
        height: 8px;
        background: #444;
        border-radius: 4px;
        margin-bottom: 20px;
        overflow: hidden;
      }
      .progress-fill {
        height: 100%;
        background: #4caf50;
        transition: width 0.3s ease;
      }
      .timer {
        font-size: 18px;
        font-weight: bold;
        color: #4caf50;
      }
      .timer.warning {
        color: #ff9800;
      }
      .timer.danger {
        color: #f44336;
      }
      .question-container {
        background: #2a2a2a;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        margin-bottom: 20px;
        border: 1px solid #444;
      }
      .question-text {
        font-size: 18px;
        font-weight: bold;
        margin-bottom: 15px;
        color: #fff;
      }
      .options {
        margin: 10px 0;
      }
      .option {
        display: block;
        margin: 8px 0;
        padding: 10px;
        border: 1px solid #444;
        border-radius: 4px;
        cursor: pointer;
        transition: background 0.2s;
        background: #1a1a1a;
        color: #fff;
      }
      .option:hover {
        background: #333;
      }
      .option input[type="radio"],
      .option input[type="checkbox"] {
        margin-right: 10px;
      }
      .pagination {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 20px;
        gap: 10px;
      }
      .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        background: #007bff;
        color: white;
        font-size: 16px;
      }
      .btn:hover {
        background: #0056b3;
      }
      .btn:disabled {
        background: #555;
        cursor: not-allowed;
      }
      .btn-danger {
        background: #f44336;
      }
      .btn-danger:hover {
        background: #da190b;
      }
      .page-info {
        font-size: 16px;
        color: #aaa;
      }
      input[type="text"] {
        background: #1a1a1a;
        border: 1px solid #444;
        color: #fff;
        padding: 8px;
        border-radius: 4px;
      }
      .name-input-box {
        background: #2a2a2a;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
        border: 1px solid #444;
      }
      .name-input-box label {
        display: block;
        margin-bottom: 8px;
        color: #fff;
        font-weight: bold;
      }
      .name-input-box input {
        width: 100%;
        max-width: 300px;
      }
    </style>
  </head>
  <body>
    <nav class="navbar">
      <div class="logo">
        <img src="/static/img/keepllogo.png" alt="Keepi Logo" height="32" />
      </div>
      <ul class="nav-links">
        <li><a href="/exams">Back to Exams</a></li>
        <li><a href="/results">Results</a></li>
        <li><a href="/about">About</a></li>
      </ul>
    </nav>

    <div class="exam-container">
      <div class="exam-header">
        <h1>Exam in Progress</h1>
        <div class="timer" id="timer">Time: 00:00</div>
      </div>

      <div class="name-input-box">
        <label for="studentName">Student Name:</label>
        <input type="text" id="studentName" placeholder="Enter your name" />
      </div>

      <div class="progress-bar">
        <div class="progress-fill" id="progressFill"></div>
      </div>

      <div id="questionContainer"></div>

      <div class="pagination">
        <button class="btn" id="prevBtn" onclick="prevPage()">
          ← Previous
        </button>
        <span class="page-info">
          Page <span id="currentPage">1</span> of <span id="totalPages">1</span>
        </span>
        <button class="btn" id="nextBtn" onclick="nextPage()">Next →</button>
      </div>

      <div style="text-align: center; margin-top: 20px">
        <button
          class="btn btn-danger"
          onclick="submitExam()"
          style="width: 200px; padding: 12px; font-size: 18px"
        >
          Submit Exam
        </button>
      </div>
    </div>

    <script>
      let examData = {};
      let currentPage = 1;
      let questionsPerPage = 10;
      let startTime = Date.now();
      let timerInterval;

      // Initialize exam
      async function initExam() {
        try {
          const response = await fetch("/exam/data");
          if (!response.ok) {
            alert("Failed to load exam data");
            window.location.href = "/exams";
            return;
          }
          examData = await response.json();
          if (!examData.questions || examData.questions.length === 0) {
            alert("No questions found. Please upload a document first.");
            window.location.href = "/exams";
            return;
          }
          const totalPages = Math.ceil(
            examData.questions.length / questionsPerPage
          );
          document.getElementById("totalPages").textContent = totalPages;
          renderPage(1);
          startTimer();
        } catch (err) {
          console.error("Error loading exam:", err);
          alert("Error loading exam data");
          window.location.href = "/exams";
        }
      }

      // Render a page of questions
      function renderPage(page) {
        currentPage = page;
        const start = (page - 1) * questionsPerPage;
        const end = start + questionsPerPage;
        const questions = examData.questions.slice(start, end);

        let html = "";
        questions.forEach((q, idx) => {
          const questionNum = start + idx + 1;
          const qId = `q${q.id}`;
          html += `<div class="question-container">
          <div class="question-text">Q${questionNum}: ${q.question}</div>
          <div class="options">`;

          if (q.type === "mcq" && q.options) {
            q.options.forEach((opt, optIdx) => {
              const optId = `${qId}_opt${optIdx}`;
              const checked =
                examData.answers && examData.answers[qId] === opt
                  ? "checked"
                  : "";
              html += `<label class="option">
              <input type="radio" id="${optId}" name="${qId}" value="${opt}" ${checked}>
              ${opt}
            </label>`;
            });
          } else if (q.type === "true_false") {
            const trueChecked =
              examData.answers && examData.answers[qId] === "True"
                ? "checked"
                : "";
            const falseChecked =
              examData.answers && examData.answers[qId] === "False"
                ? "checked"
                : "";
            html += `<label class="option">
            <input type="radio" name="${qId}" value="True" ${trueChecked}> True
          </label>
          <label class="option">
            <input type="radio" name="${qId}" value="False" ${falseChecked}> False
          </label>`;
          } else if (q.type === "fill_blank" || q.type === "descriptive") {
            const value =
              examData.answers && examData.answers[qId]
                ? examData.answers[qId]
                : "";
            html += `<input type="text" name="${qId}" placeholder="Your answer" value="${value}" style="width:100%; padding:8px; margin-top:6px;" maxlength="5000">`;
          }
          html += `</div></div>`;
        });

        document.getElementById("questionContainer").innerHTML = html;
        document.getElementById("currentPage").textContent = page;

        // Update progress bar
        const totalPages = Math.ceil(
          examData.questions.length / questionsPerPage
        );
        const progress = (page / totalPages) * 100;
        document.getElementById("progressFill").style.width = progress + "%";

        // Update button states
        document.getElementById("prevBtn").disabled = page === 1;
        document.getElementById("nextBtn").disabled = page === totalPages;

        // Capture answers for current page
        captureAnswers();
      }

      // Capture answers from current page
      function captureAnswers() {
        if (!examData.answers) examData.answers = {};
        const inputs = document.querySelectorAll(
          "#questionContainer input, #questionContainer textarea"
        );
        inputs.forEach((input) => {
          if (input.type === "radio") {
            if (input.checked) {
              examData.answers[input.name] = input.value;
            }
          } else if (input.type === "text") {
            examData.answers[input.name] = input.value;
          }
        });
      }

      // Navigation
      function prevPage() {
        captureAnswers();
        if (currentPage > 1) renderPage(currentPage - 1);
      }

      function nextPage() {
        captureAnswers();
        const totalPages = Math.ceil(
          examData.questions.length / questionsPerPage
        );
        if (currentPage < totalPages) renderPage(currentPage + 1);
      }

      // Timer
      function startTimer() {
        timerInterval = setInterval(() => {
          const elapsed = Math.floor((Date.now() - startTime) / 1000);
          const minutes = Math.floor(elapsed / 60);
          const seconds = elapsed % 60;
          document.getElementById("timer").textContent = `Time: ${String(
            minutes
          ).padStart(2, "0")}:${String(seconds).padStart(2, "0")}`;
        }, 1000);
      }

      // Submit exam
      async function submitExam() {
        const studentName = document.getElementById("studentName").value.trim();
        if (!studentName) {
          alert("Please enter your name before submitting.");
          return;
        }
        captureAnswers();
        if (!confirm("Are you sure you want to submit the exam?")) return;

        const payload = {
          ...examData,
          student_name: studentName,
          started_at: new Date(startTime).toISOString(),
          submitted_at: new Date().toISOString(),
        };

        try {
          const response = await fetch("/exam/submit", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
          const result = await response.json();
          if (response.ok) {
            alert(`Exam submitted! Score: ${result.score}/${result.total}`);
            clearInterval(timerInterval);
            window.location.href = "/results";
          } else {
            alert(
              "Error submitting exam: " + (result.error || "Unknown error")
            );
          }
        } catch (err) {
          console.error("Error submitting exam:", err);
          alert("Error submitting exam");
        }
      }

      // Initialize on page load
      window.addEventListener("load", initExam);
    </script>
  </body>
</html>
