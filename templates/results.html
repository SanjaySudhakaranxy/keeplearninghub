<<<<<<< HEAD
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Exam Question Extractor - Results</title>
    <link rel="stylesheet" href="/static/style.css" />
    <style>
      body {
        background: #000000;
        background: linear-gradient(
          135deg,
          #000000 0%,
          #0a0a0a 50%,
          #000000 100%
        );
        color: #fff;
      }
      .result-list ul {
        list-style: none;
        padding: 0;
      }
      .result-actions {
        margin-top: 12px;
        padding-top: 12px;
        border-top: 1px solid rgba(255, 255, 255, 0.1);
        display: flex;
        gap: 8px;
      }
    </style>
  </head>
  <body>
    <nav class="navbar">
      <div class="logo">
        <img src="/static/img/keepllogo.png" alt="Keepi Logo" height="32" />
      </div>
      <ul class="nav-links">
        <li><a href="/exams">Exams</a></li>
        <li><a href="/library">Library</a></li>
        <li><a href="/results" class="active">Results</a></li>
        <li><a href="/about">About</a></li>
        <li><a href="/logout" class="logout-link">Logout</a></li>
      </ul>
    </nav>
    <main>
      <section class="results-section">
        <h1>Results</h1>
        <p>Your scores and performance will appear here.</p>

        <div class="result-list">
          {% if results and results|length > 0 %}
          <ul>
            {% for r in results %}
            <li class="result-item">
              <div class="result-header">
                {{ r.student_name or 'Unknown' }} ‚Äî {{ r.score }}/{{ r.total }}
                ({{ r.percentage }}%)
              </div>
              <div class="result-details">
                <div>
                  üìÖ Started:
                  <script>
                    (function () {
                      const date = new Date("{{ r.started_at }}");
                      const formatted = date.toLocaleString("en-US", {
                        year: "numeric",
                        month: "short",
                        day: "numeric",
                        hour: "2-digit",
                        minute: "2-digit",
                        second: "2-digit",
                      });
                      document.write(formatted);
                    })();
                  </script>
                </div>
                <div>
                  üì§ Submitted:
                  <script>
                    (function () {
                      const date = new Date(
                        "{{ r.submitted_at or r.timestamp }}"
                      );
                      const formatted = date.toLocaleString("en-US", {
                        year: "numeric",
                        month: "short",
                        day: "numeric",
                        hour: "2-digit",
                        minute: "2-digit",
                        second: "2-digit",
                      });
                      document.write(formatted);
                    })();
                  </script>
                </div>
                {% if r.started_at and r.submitted_at %}
                <div>
                  ‚è±Ô∏è Duration:
                  <script>
                    (function () {
                      const start = new Date("{{ r.started_at }}");
                      const end = new Date("{{ r.submitted_at }}");
                      const diff = (end - start) / 1000;
                      const mins = Math.floor(diff / 60);
                      const secs = Math.floor(diff % 60);
                      document.write(mins + "m " + secs + "s");
                    })();
                  </script>
                </div>
                {% endif %}
              </div>
              <div class="result-actions">
                <button
                  class="download-result-btn"
                  onclick="downloadResultDetail({{ loop.index0 }})"
                >
                  üì• Download Report
                </button>
              </div>
            </li>
            {% endfor %}
          </ul>
          {% else %}
          <div class="result-placeholder">
            <p>No results available yet.</p>
          </div>
          {% endif %}
        </div>
      </section>
      <div style="text-align: center; margin: 30px 0 0 0">
        <form
          method="POST"
          action="/clear_results"
          onsubmit="return confirm('Are you sure you want to clear all results? This cannot be undone.');"
        >
          <button
            type="submit"
            style="
              background: #ff6b6b;
              color: #fff;
              padding: 12px 32px;
              border: none;
              border-radius: 6px;
              font-size: 18px;
              font-weight: bold;
              cursor: pointer;
              box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
              margin-top: 10px;
            "
          >
            üóëÔ∏è Clear All Results
          </button>
        </form>
      </div>
    </main>
    <footer>
      <span>¬© 2025 Made by Jay</span>
    </footer>

    <script>
      // Prepare results data from the page
      const resultsData = [
        {% for r in results %}
        {
          student_name: "{{ r.student_name or 'Unknown' }}",
          score: {{ r.score }},
          total: {{ r.total }},
          percentage: {{ r.percentage }},
          started_at: "{{ r.started_at }}",
          submitted_at: "{{ r.submitted_at or r.timestamp }}",
          timestamp: "{{ r.timestamp or r.submitted_at }}",
          questions: {{ r.questions | tojson if r.get('questions') else '[]' }},
          answers: {{ r.answers | tojson if r.get('answers') else '{}' }}
        }{% if not loop.last %},{% endif %}
        {% endfor %}
      ];

      // Format date helper
      function formatDate(dateStr) {
        const date = new Date(dateStr);
        return date.toLocaleString("en-US", {
          year: "numeric",
          month: "short",
          day: "numeric",
          hour: "2-digit",
          minute: "2-digit",
          second: "2-digit",
        });
      }

      // Calculate duration
      function calculateDuration(startStr, endStr) {
        const start = new Date(startStr);
        const end = new Date(endStr);
        const diff = (end - start) / 1000;
        const mins = Math.floor(diff / 60);
        const secs = Math.floor(diff % 60);
        return mins + "m " + secs + "s";
      }

      // Download as CSV
      function downloadCSV() {
        if (!resultsData || resultsData.length === 0) {
          alert("No results to download");
          return;
        }

        let csv = "Student Name,Score,Total,Percentage,Started,Submitted,Duration\n";

        resultsData.forEach(r => {
          const started = formatDate(r.started_at);
          const submitted = formatDate(r.submitted_at);
          const duration = calculateDuration(r.started_at, r.submitted_at);

          csv += `"${r.student_name}",${r.score},${r.total},${r.percentage}%,"${started}","${submitted}","${duration}"\n`;
        });

        // Download CSV file
        const blob = new Blob([csv], { type: "text/csv" });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `exam_results_${new Date().toISOString().split('T')[0]}.csv`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
      }

      // Download as JSON
      function downloadJSON() {
        if (!resultsData || resultsData.length === 0) {
          alert("No results to download");
          return;
        }

        const formattedData = resultsData.map(r => ({
          student_name: r.student_name,
          score: r.score,
          total: r.total,
          percentage: r.percentage,
          started: formatDate(r.started_at),
          submitted: formatDate(r.submitted_at),
          duration: calculateDuration(r.started_at, r.submitted_at)
        }));

        const json = JSON.stringify(formattedData, null, 2);
        const blob = new Blob([json], { type: "application/json" });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `exam_results_${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
      }

      // Calculate similarity between two strings
      function calculateSimilarity(str1, str2) {
        if (!str1 || !str2) return str1 === str2 ? 1 : 0;

        const s1 = str1.trim().toLowerCase();
        const s2 = str2.trim().toLowerCase();

        if (s1 === s2) return 1.0;

        // Extract words
        const words1 = new Set(s1.match(/\w+/g) || []);
        const words2 = new Set(s2.match(/\w+/g) || []);

        // Calculate Jaccard similarity for keywords
        const intersection = new Set([...words1].filter(x => words2.has(x)));
        const union = new Set([...words1, ...words2]);
        const keywordSimilarity = union.size > 0 ? intersection.size / union.size : 0;

        // Simple string similarity using character matching
        let matches = 0;
        const minLen = Math.min(s1.length, s2.length);
        for (let i = 0; i < minLen; i++) {
          if (s1[i] === s2[i]) matches++;
        }
        const stringSimilarity = matches / Math.max(s1.length, s2.length);

        // Weighted average
        const similarity = (keywordSimilarity * 0.6) + (stringSimilarity * 0.4);
        return similarity;
      }

      // Determine if answer is correct based on similarity
      function checkAnswerCorrect(userAnswer, correctAnswer, questionType) {
        if (!userAnswer) return false;

        const similarity = calculateSimilarity(userAnswer, correctAnswer);

        // Set threshold based on question type
        let threshold = 0.70; // default for descriptive
        if (questionType === 'mcq' || questionType === 'true_false') {
          threshold = 0.95; // MCQ and True/False need high accuracy
        } else if (questionType === 'fill_blank') {
          threshold = 0.85; // Fill-blank needs reasonable match
        }

        return similarity >= threshold;
      }

      // Download individual result detail (optimized for large exams)
      function downloadResultDetail(index) {
        if (!resultsData || !resultsData[index]) {
          alert("Result not found");
          return;
        }

        // Show loading spinner
        const spinner = document.createElement('div');
        spinner.id = 'report-spinner';
        spinner.style.position = 'fixed';
        spinner.style.top = '0';
        spinner.style.left = '0';
        spinner.style.width = '100vw';
        spinner.style.height = '100vh';
        spinner.style.background = 'rgba(30,30,30,0.7)';
        spinner.style.zIndex = '9999';
        spinner.style.display = 'flex';
        spinner.style.alignItems = 'center';
        spinner.style.justifyContent = 'center';
        spinner.innerHTML = '<div style="color:#fff;font-size:2em;text-align:center"><span style="font-size:3em">‚è≥</span><br>Generating report...<br><small>This may take a few seconds for large exams.</small></div>';
        document.body.appendChild(spinner);

        setTimeout(() => {
          const r = resultsData[index];
          const started = formatDate(r.started_at);
          const submitted = formatDate(r.submitted_at);
          const duration = calculateDuration(r.started_at, r.submitted_at);

          // Warn if very large
          if (r.questions && r.questions.length > 200) {
            if (!confirm(`This report contains ${r.questions.length} questions and may take a while to generate. Continue?`)) {
              document.body.removeChild(spinner);
              return;
            }
          }

          // Chunked string building for memory efficiency
          const reportChunks = [];
          reportChunks.push(`EXAM RESULT REPORT\n`);
          reportChunks.push(`${'='.repeat(70)}\n\n`);
          reportChunks.push(`Student Name: ${r.student_name}\n`);
          reportChunks.push(`Score: ${r.score}/${r.total}\n`);
          reportChunks.push(`Percentage: ${r.percentage}%\n\n`);
          reportChunks.push(`Exam Details:\n`);
          reportChunks.push(`${'-'.repeat(70)}\n`);
          reportChunks.push(`Started: ${started}\n`);
          reportChunks.push(`Submitted: ${submitted}\n`);
          reportChunks.push(`Duration: ${duration}\n`);
          reportChunks.push(`\n${'='.repeat(70)}\n\n`);

          // Add questions and answers
          if (r.questions && r.questions.length > 0) {
            reportChunks.push(`DETAILED QUESTIONS & ANSWERS FOR HUMAN VERIFICATION\n`);
            reportChunks.push(`${'='.repeat(70)}\n\n`);
            reportChunks.push(`Total Questions: ${r.questions.length}\n\n`);

            for (let idx = 0; idx < r.questions.length; idx++) {
              const q = r.questions[idx];
              const qNum = idx + 1;
              const qId = `q${q.id}`;
              const userAnswer = r.answers[qId] || '(No answer provided)';
              const correctAnswer = q.correct_answer || '(No answer key)';
              const isCorrect = checkAnswerCorrect(userAnswer, correctAnswer, q.type);

              reportChunks.push(`QUESTION ${qNum}\n`);
              reportChunks.push(`${'-'.repeat(70)}\n`);
              reportChunks.push(`Question: ${q.question}\n`);
              reportChunks.push(`Type: ${q.type.toUpperCase()}\n\n`);

              // Show options for MCQ
              if (q.type === 'mcq' && q.options) {
                reportChunks.push(`Available Options:\n`);
                for (let i = 0; i < q.options.length; i++) {
                  const opt = q.options[i];
                  const isSelected = userAnswer.toLowerCase().includes(opt.toLowerCase());
                  let optLine = `  ${String.fromCharCode(97 + i)}) ${opt}`;
                  if (isSelected) optLine += ` ‚Üê SELECTED`;
                  reportChunks.push(optLine + '\n');
                }
                reportChunks.push(`\n`);
              }
              // Show options for True/False
              else if (q.type === 'true_false') {
                reportChunks.push(`Available Options: True, False\n\n`);
              }
              // For fill-blank and descriptive, show hint about expected answer
              else if (q.type === 'fill_blank') {
                reportChunks.push(`(Fill in the blank question)\n\n`);
              }
              else if (q.type === 'descriptive') {
                reportChunks.push(`(Descriptive/Essay question)\n\n`);
              }

              reportChunks.push(`STUDENT'S ANSWER: ${userAnswer}\n`);
              reportChunks.push(`CORRECT ANSWER: ${correctAnswer}\n`);
              reportChunks.push(`VERIFICATION STATUS: ${isCorrect ? '‚úì CORRECT - APPROVED' : '‚úó INCORRECT - REVIEW NEEDED'}\n`);

              // Add note for human review
              if (!isCorrect && userAnswer !== '(No answer provided)') {
                reportChunks.push(`\nNOTE: Please verify if the student's answer is acceptable. It may contain\n`);
                reportChunks.push(`alternative correct phrasing or valid interpretation.\n`);
              }

              reportChunks.push(`\n${'='.repeat(70)}\n\n`);
            }
          }

          reportChunks.push(`\nSUMMARY\n`);
          reportChunks.push(`${'='.repeat(70)}\n`);
          reportChunks.push(`Total Questions: ${r.total}\n`);
          reportChunks.push(`Correct Answers: ${r.score}\n`);
          reportChunks.push(`Incorrect/Unanswered: ${r.total - r.score}\n`);
          reportChunks.push(`Final Score: ${r.score}/${r.total} (${r.percentage}%)\n`);
          reportChunks.push(`\nNOTE FOR HUMAN REVIEWER:\n`);
          reportChunks.push(`Please review all questions marked as INCORRECT above.\n`);
          reportChunks.push(`Student responses may contain valid alternative answers or interpretations.\n`);
          reportChunks.push(`Manual verification is recommended for descriptive and fill-blank questions.\n`);

          reportChunks.push(`\n${'='.repeat(70)}\n`);
          reportChunks.push(`END OF EXAM REPORT - Generated for Human Verification\n`);
          reportChunks.push(`${'='.repeat(70)}\n`);

          // Download as text file
          const report = reportChunks.join('');
          const blob = new Blob([report], { type: "text/plain" });
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = `exam_result_${r.student_name.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.txt`;
          document.body.appendChild(a);
          a.click();
          window.URL.revokeObjectURL(url);
          document.body.removeChild(a);

          // Remove spinner
          document.body.removeChild(spinner);
        }, 100);
      }
    </script>
  </body>
  <script>
    // Fade-in/fade-out and scroll transitions
    document.addEventListener("DOMContentLoaded", function () {
      document.body.classList.add("fade-in");
      // Fade-out on navigation
      document.querySelectorAll("a").forEach(function (link) {
        link.addEventListener("click", function (e) {
          if (
            link.target !== "_blank" &&
            link.href &&
            link.href.indexOf(location.host) !== -1
          ) {
            e.preventDefault();
            document.body.classList.remove("fade-in");
            document.body.classList.add("fade-out");
            setTimeout(function () {
              window.location.href = link.href;
            }, 350);
          }
        });
      });
      // Section fade-in on scroll
      const fadeSections = document.querySelectorAll(".section-fade");
      function handleSectionFade() {
        fadeSections.forEach(function (section) {
          const rect = section.getBoundingClientRect();
          if (rect.top < window.innerHeight - 60) {
            section.classList.add("visible");
          }
        });
      }
      window.addEventListener("scroll", handleSectionFade);
      handleSectionFade();
    });
  </script>
</html>
=======
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Exam Question Extractor - Results</title>
    <link rel="stylesheet" href="/static/style.css" />
    <style>
      body {
        background: #1a1a1a;
        color: #fff;
      }
      .results-section {
        color: #fff;
      }
      .result-list ul {
        list-style: none;
        padding: 0;
      }
      .result-item {
        margin-bottom: 16px;
        padding: 12px;
        border: 1px solid #444;
        background: #2a2a2a;
        border-radius: 6px;
      }
      .result-header {
        font-weight: bold;
        margin-bottom: 4px;
        color: #4caf50;
      }
      .result-details {
        font-size: 13px;
        color: #aaa;
        margin-top: 6px;
        line-height: 1.6;
      }
      .result-actions {
        margin-top: 12px;
        padding-top: 12px;
        border-top: 1px solid #444;
        display: flex;
        gap: 8px;
      }
      .download-result-btn {
        padding: 8px 14px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        background: #4caf50;
        color: white;
        font-size: 12px;
        font-weight: bold;
        transition: background 0.2s;
      }
      .download-result-btn:hover {
        background: #45a049;
      }
    </style>
  </head>
  <body>
    <nav class="navbar">
      <div class="logo">
        <img src="/static/img/keepllogo.png" alt="Keepi Logo" height="32" />
      </div>
      <ul class="nav-links">
        <li><a href="/exams">Exams</a></li>
        <li><a href="/results" class="active">Results</a></li>
        <li><a href="/about">About</a></li>
        <li><a href="/logout" class="logout-link">Logout</a></li>
      </ul>
    </nav>
    <main>
      <section class="results-section">
        <h1>Results</h1>
        <p>Your scores and performance will appear here.</p>

        <div class="result-list">
          {% if results and results|length > 0 %}
          <ul>
            {% for r in results %}
            <li class="result-item">
              <div class="result-header">
                {{ r.student_name or 'Unknown' }} ‚Äî {{ r.score }}/{{ r.total }}
                ({{ r.percentage }}%)
              </div>
              <div class="result-details">
                <div>
                  üìÖ Started:
                  <script>
                    (function () {
                      const date = new Date("{{ r.started_at }}");
                      const formatted = date.toLocaleString("en-US", {
                        year: "numeric",
                        month: "short",
                        day: "numeric",
                        hour: "2-digit",
                        minute: "2-digit",
                        second: "2-digit",
                      });
                      document.write(formatted);
                    })();
                  </script>
                </div>
                <div>
                  üì§ Submitted:
                  <script>
                    (function () {
                      const date = new Date(
                        "{{ r.submitted_at or r.timestamp }}"
                      );
                      const formatted = date.toLocaleString("en-US", {
                        year: "numeric",
                        month: "short",
                        day: "numeric",
                        hour: "2-digit",
                        minute: "2-digit",
                        second: "2-digit",
                      });
                      document.write(formatted);
                    })();
                  </script>
                </div>
                {% if r.started_at and r.submitted_at %}
                <div>
                  ‚è±Ô∏è Duration:
                  <script>
                    (function () {
                      const start = new Date("{{ r.started_at }}");
                      const end = new Date("{{ r.submitted_at }}");
                      const diff = (end - start) / 1000;
                      const mins = Math.floor(diff / 60);
                      const secs = Math.floor(diff % 60);
                      document.write(mins + "m " + secs + "s");
                    })();
                  </script>
                </div>
                {% endif %}
              </div>
              <div class="result-actions">
                <button
                  class="download-result-btn"
                  onclick="downloadResultDetail({{ loop.index0 }})"
                >
                  üì• Download Report
                </button>
              </div>
            </li>
            {% endfor %}
          </ul>
          {% else %}
          <div class="result-placeholder">
            <p>No results available yet.</p>
          </div>
          {% endif %}
        </div>
      </section>
      <div style="text-align: center; margin: 30px 0 0 0">
        <form
          method="POST"
          action="/clear_results"
          onsubmit="return confirm('Are you sure you want to clear all results? This cannot be undone.');"
        >
          <button
            type="submit"
            style="
              background: #ff6b6b;
              color: #fff;
              padding: 12px 32px;
              border: none;
              border-radius: 6px;
              font-size: 18px;
              font-weight: bold;
              cursor: pointer;
              box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
              margin-top: 10px;
            "
          >
            üóëÔ∏è Clear All Results
          </button>
        </form>
      </div>
    </main>
    <footer>
      <span>¬© 2025 Made by Jay</span>
    </footer>

    <script>
      // Prepare results data from the page
      const resultsData = [
        {% for r in results %}
        {
          student_name: "{{ r.student_name or 'Unknown' }}",
          score: {{ r.score }},
          total: {{ r.total }},
          percentage: {{ r.percentage }},
          started_at: "{{ r.started_at }}",
          submitted_at: "{{ r.submitted_at or r.timestamp }}",
          timestamp: "{{ r.timestamp or r.submitted_at }}",
          questions: {{ r.questions | tojson if r.get('questions') else '[]' }},
          answers: {{ r.answers | tojson if r.get('answers') else '{}' }}
        }{% if not loop.last %},{% endif %}
        {% endfor %}
      ];

      // Format date helper
      function formatDate(dateStr) {
        const date = new Date(dateStr);
        return date.toLocaleString("en-US", {
          year: "numeric",
          month: "short",
          day: "numeric",
          hour: "2-digit",
          minute: "2-digit",
          second: "2-digit",
        });
      }

      // Calculate duration
      function calculateDuration(startStr, endStr) {
        const start = new Date(startStr);
        const end = new Date(endStr);
        const diff = (end - start) / 1000;
        const mins = Math.floor(diff / 60);
        const secs = Math.floor(diff % 60);
        return mins + "m " + secs + "s";
      }

      // Download as CSV
      function downloadCSV() {
        if (!resultsData || resultsData.length === 0) {
          alert("No results to download");
          return;
        }

        let csv = "Student Name,Score,Total,Percentage,Started,Submitted,Duration\n";

        resultsData.forEach(r => {
          const started = formatDate(r.started_at);
          const submitted = formatDate(r.submitted_at);
          const duration = calculateDuration(r.started_at, r.submitted_at);

          csv += `"${r.student_name}",${r.score},${r.total},${r.percentage}%,"${started}","${submitted}","${duration}"\n`;
        });

        // Download CSV file
        const blob = new Blob([csv], { type: "text/csv" });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `exam_results_${new Date().toISOString().split('T')[0]}.csv`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
      }

      // Download as JSON
      function downloadJSON() {
        if (!resultsData || resultsData.length === 0) {
          alert("No results to download");
          return;
        }

        const formattedData = resultsData.map(r => ({
          student_name: r.student_name,
          score: r.score,
          total: r.total,
          percentage: r.percentage,
          started: formatDate(r.started_at),
          submitted: formatDate(r.submitted_at),
          duration: calculateDuration(r.started_at, r.submitted_at)
        }));

        const json = JSON.stringify(formattedData, null, 2);
        const blob = new Blob([json], { type: "application/json" });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `exam_results_${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
      }

      // Calculate similarity between two strings
      function calculateSimilarity(str1, str2) {
        if (!str1 || !str2) return str1 === str2 ? 1 : 0;

        const s1 = str1.trim().toLowerCase();
        const s2 = str2.trim().toLowerCase();

        if (s1 === s2) return 1.0;

        // Extract words
        const words1 = new Set(s1.match(/\w+/g) || []);
        const words2 = new Set(s2.match(/\w+/g) || []);

        // Calculate Jaccard similarity for keywords
        const intersection = new Set([...words1].filter(x => words2.has(x)));
        const union = new Set([...words1, ...words2]);
        const keywordSimilarity = union.size > 0 ? intersection.size / union.size : 0;

        // Simple string similarity using character matching
        let matches = 0;
        const minLen = Math.min(s1.length, s2.length);
        for (let i = 0; i < minLen; i++) {
          if (s1[i] === s2[i]) matches++;
        }
        const stringSimilarity = matches / Math.max(s1.length, s2.length);

        // Weighted average
        const similarity = (keywordSimilarity * 0.6) + (stringSimilarity * 0.4);
        return similarity;
      }

      // Determine if answer is correct based on similarity
      function checkAnswerCorrect(userAnswer, correctAnswer, questionType) {
        if (!userAnswer) return false;

        const similarity = calculateSimilarity(userAnswer, correctAnswer);

        // Set threshold based on question type
        let threshold = 0.70; // default for descriptive
        if (questionType === 'mcq' || questionType === 'true_false') {
          threshold = 0.95; // MCQ and True/False need high accuracy
        } else if (questionType === 'fill_blank') {
          threshold = 0.85; // Fill-blank needs reasonable match
        }

        return similarity >= threshold;
      }

      // Download individual result detail (optimized for large exams)
      function downloadResultDetail(index) {
        if (!resultsData || !resultsData[index]) {
          alert("Result not found");
          return;
        }

        // Show loading spinner
        const spinner = document.createElement('div');
        spinner.id = 'report-spinner';
        spinner.style.position = 'fixed';
        spinner.style.top = '0';
        spinner.style.left = '0';
        spinner.style.width = '100vw';
        spinner.style.height = '100vh';
        spinner.style.background = 'rgba(30,30,30,0.7)';
        spinner.style.zIndex = '9999';
        spinner.style.display = 'flex';
        spinner.style.alignItems = 'center';
        spinner.style.justifyContent = 'center';
        spinner.innerHTML = '<div style="color:#fff;font-size:2em;text-align:center"><span style="font-size:3em">‚è≥</span><br>Generating report...<br><small>This may take a few seconds for large exams.</small></div>';
        document.body.appendChild(spinner);

        setTimeout(() => {
          const r = resultsData[index];
          const started = formatDate(r.started_at);
          const submitted = formatDate(r.submitted_at);
          const duration = calculateDuration(r.started_at, r.submitted_at);

          // Warn if very large
          if (r.questions && r.questions.length > 200) {
            if (!confirm(`This report contains ${r.questions.length} questions and may take a while to generate. Continue?`)) {
              document.body.removeChild(spinner);
              return;
            }
          }

          // Chunked string building for memory efficiency
          const reportChunks = [];
          reportChunks.push(`EXAM RESULT REPORT\n`);
          reportChunks.push(`${'='.repeat(70)}\n\n`);
          reportChunks.push(`Student Name: ${r.student_name}\n`);
          reportChunks.push(`Score: ${r.score}/${r.total}\n`);
          reportChunks.push(`Percentage: ${r.percentage}%\n\n`);
          reportChunks.push(`Exam Details:\n`);
          reportChunks.push(`${'-'.repeat(70)}\n`);
          reportChunks.push(`Started: ${started}\n`);
          reportChunks.push(`Submitted: ${submitted}\n`);
          reportChunks.push(`Duration: ${duration}\n`);
          reportChunks.push(`\n${'='.repeat(70)}\n\n`);

          // Add questions and answers
          if (r.questions && r.questions.length > 0) {
            reportChunks.push(`DETAILED QUESTIONS & ANSWERS FOR HUMAN VERIFICATION\n`);
            reportChunks.push(`${'='.repeat(70)}\n\n`);
            reportChunks.push(`Total Questions: ${r.questions.length}\n\n`);

            for (let idx = 0; idx < r.questions.length; idx++) {
              const q = r.questions[idx];
              const qNum = idx + 1;
              const qId = `q${q.id}`;
              const userAnswer = r.answers[qId] || '(No answer provided)';
              const correctAnswer = q.correct_answer || '(No answer key)';
              const isCorrect = checkAnswerCorrect(userAnswer, correctAnswer, q.type);

              reportChunks.push(`QUESTION ${qNum}\n`);
              reportChunks.push(`${'-'.repeat(70)}\n`);
              reportChunks.push(`Question: ${q.question}\n`);
              reportChunks.push(`Type: ${q.type.toUpperCase()}\n\n`);

              // Show options for MCQ
              if (q.type === 'mcq' && q.options) {
                reportChunks.push(`Available Options:\n`);
                for (let i = 0; i < q.options.length; i++) {
                  const opt = q.options[i];
                  const isSelected = userAnswer.toLowerCase().includes(opt.toLowerCase());
                  let optLine = `  ${String.fromCharCode(97 + i)}) ${opt}`;
                  if (isSelected) optLine += ` ‚Üê SELECTED`;
                  reportChunks.push(optLine + '\n');
                }
                reportChunks.push(`\n`);
              }
              // Show options for True/False
              else if (q.type === 'true_false') {
                reportChunks.push(`Available Options: True, False\n\n`);
              }
              // For fill-blank and descriptive, show hint about expected answer
              else if (q.type === 'fill_blank') {
                reportChunks.push(`(Fill in the blank question)\n\n`);
              }
              else if (q.type === 'descriptive') {
                reportChunks.push(`(Descriptive/Essay question)\n\n`);
              }

              reportChunks.push(`STUDENT'S ANSWER: ${userAnswer}\n`);
              reportChunks.push(`CORRECT ANSWER: ${correctAnswer}\n`);
              reportChunks.push(`VERIFICATION STATUS: ${isCorrect ? '‚úì CORRECT - APPROVED' : '‚úó INCORRECT - REVIEW NEEDED'}\n`);

              // Add note for human review
              if (!isCorrect && userAnswer !== '(No answer provided)') {
                reportChunks.push(`\nNOTE: Please verify if the student's answer is acceptable. It may contain\n`);
                reportChunks.push(`alternative correct phrasing or valid interpretation.\n`);
              }

              reportChunks.push(`\n${'='.repeat(70)}\n\n`);
            }
          }

          reportChunks.push(`\nSUMMARY\n`);
          reportChunks.push(`${'='.repeat(70)}\n`);
          reportChunks.push(`Total Questions: ${r.total}\n`);
          reportChunks.push(`Correct Answers: ${r.score}\n`);
          reportChunks.push(`Incorrect/Unanswered: ${r.total - r.score}\n`);
          reportChunks.push(`Final Score: ${r.score}/${r.total} (${r.percentage}%)\n`);
          reportChunks.push(`\nNOTE FOR HUMAN REVIEWER:\n`);
          reportChunks.push(`Please review all questions marked as INCORRECT above.\n`);
          reportChunks.push(`Student responses may contain valid alternative answers or interpretations.\n`);
          reportChunks.push(`Manual verification is recommended for descriptive and fill-blank questions.\n`);

          reportChunks.push(`\n${'='.repeat(70)}\n`);
          reportChunks.push(`END OF EXAM REPORT - Generated for Human Verification\n`);
          reportChunks.push(`${'='.repeat(70)}\n`);

          // Download as text file
          const report = reportChunks.join('');
          const blob = new Blob([report], { type: "text/plain" });
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = `exam_result_${r.student_name.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.txt`;
          document.body.appendChild(a);
          a.click();
          window.URL.revokeObjectURL(url);
          document.body.removeChild(a);

          // Remove spinner
          document.body.removeChild(spinner);
        }, 100);
      }
    </script>
  </body>
</html>
>>>>>>> cd2f4aee2e9ec31cc816fab479d648db4b76f4da
